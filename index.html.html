<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Generador de Memes ðŸŽ‰</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    margin: 0;
    user-select: none;
  }
  h1 {
    margin-bottom: 15px;
  }
  canvas {
    border: 4px solid #0f0;
    border-radius: 12px;
    max-width: 90vw;
    max-height: 70vh;
    cursor: grab;
    background: #222;
    transition: box-shadow 0.3s ease;
  }
  canvas:active {
    cursor: grabbing;
    box-shadow: 0 0 15px #0f0;
  }
  input, button, textarea {
    margin: 8px 0;
    padding: 10px 12px;
    width: 320px;
    max-width: 90vw;
    border-radius: 8px;
    border: none;
    font-size: 16px;
  }
  input[type="file"] {
    padding: 5px;
    width: auto;
  }
  button {
    background: #0f0;
    color: #121212;
    font-weight: 700;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  button:hover:not(:disabled) {
    background: #0c0;
  }
  button:disabled {
    background: #444;
    cursor: not-allowed;
  }
  label {
    margin-top: 12px;
    font-weight: 600;
  }
  #controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100%;
    max-width: 350px;
  }
  #info {
    margin-top: 8px;
    font-size: 14px;
    color: #999;
  }
</style>
</head>
<body>

<h1>Generador de Memes ðŸŽ‰</h1>

<div id="controls">
  <input type="file" id="img-upload" accept="image/*" />
  <label for="top-text">Texto superior</label>
  <input type="text" id="top-text" placeholder="Texto arriba..." maxlength="100" />
  <label for="bottom-text">Texto inferior</label>
  <input type="text" id="bottom-text" placeholder="Texto abajo..." maxlength="100" />
  <div style="display: flex; gap: 10px; margin-top: 10px;">
    <button id="generate-btn" disabled>Generar Meme</button>
    <button id="download-btn" disabled>Descargar Meme</button>
    <button id="clear-btn">Limpiar</button>
  </div>
  <div id="info">Puedes arrastrar el texto sobre la imagen para moverlo.</div>
</div>

<canvas id="meme-canvas" width="500" height="500"></canvas>

<script>
  const canvas = document.getElementById('meme-canvas');
  const ctx = canvas.getContext('2d');
  const imgUpload = document.getElementById('img-upload');
  const topTextInput = document.getElementById('top-text');
  const bottomTextInput = document.getElementById('bottom-text');
  const generateBtn = document.getElementById('generate-btn');
  const downloadBtn = document.getElementById('download-btn');
  const clearBtn = document.getElementById('clear-btn');

  let img = new Image();
  let memeReady = false;

  // Posiciones iniciales del texto
  let topTextPos = { x: canvas.width / 2, y: 40 };
  let bottomTextPos = { x: canvas.width / 2, y: canvas.height - 40 };

  let draggingText = null; // 'top' o 'bottom'
  let offset = { x: 0, y: 0 };

  function fitImageOnCanvas(image, canvas) {
    let imgRatio = image.width / image.height;
    let canvasRatio = canvas.width / canvas.height;
    let width, height;

    if(imgRatio > canvasRatio) {
      width = canvas.width;
      height = width / imgRatio;
    } else {
      height = canvas.height;
      width = height * imgRatio;
    }
    return { width, height };
  }

  imgUpload.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
      img = new Image();
      img.src = event.target.result;
      img.onload = () => {
        const size = fitImageOnCanvas(img, canvas);
        canvas.width = size.width;
        canvas.height = size.height;
        // Reset positions
        topTextPos = { x: canvas.width / 2, y: 40 };
        bottomTextPos = { x: canvas.width / 2, y: canvas.height - 40 };
        drawMeme();
        memeReady = true;
        generateBtn.disabled = false;
        downloadBtn.disabled = false;
      }
    };
    reader.readAsDataURL(file);
  });

  function drawText(text, x, y) {
    const maxWidth = canvas.width * 0.9;
    let fontSize = canvas.height / 10;
    ctx.font = `bold ${fontSize}px Impact`;
    ctx.textAlign = 'center';
    ctx.lineJoin = 'round';
    ctx.lineWidth = fontSize / 8;
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'black';

    // Ajusta tamaÃ±o para que quepa
    while(ctx.measureText(text).width > maxWidth && fontSize > 10) {
      fontSize -= 2;
      ctx.font = `bold ${fontSize}px Impact`;
      ctx.lineWidth = fontSize / 8;
    }

    ctx.fillText(text, x, y);
    ctx.strokeText(text, x, y);
  }

  function drawMeme() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    drawText(topTextInput.value.toUpperCase(), topTextPos.x, topTextPos.y);
    drawText(bottomTextInput.value.toUpperCase(), bottomTextPos.x, bottomTextPos.y);
  }

  generateBtn.addEventListener('click', () => {
    if(!memeReady) {
      alert('Por favor, sube una imagen primero.');
      return;
    }
    drawMeme();
  });

  downloadBtn.addEventListener('click', () => {
    if(!memeReady) return;
    const link = document.createElement('a');
    link.download = 'meme.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });

  clearBtn.addEventListener('click', () => {
    img = new Image();
    memeReady = false;
    generateBtn.disabled = true;
    downloadBtn.disabled = true;
    topTextInput.value = '';
    bottomTextInput.value = '';
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  });

  // Dibuja al escribir (preview instantÃ¡neo)
  topTextInput.addEventListener('input', () => {
    if(memeReady) drawMeme();
  });
  bottomTextInput.addEventListener('input', () => {
    if(memeReady) drawMeme();
  });

  // Drag and drop texto
  function isInsideText(x, y, textPos) {
    const fontSize = canvas.height / 10;
    ctx.font = `bold ${fontSize}px Impact`;
    const textWidth = ctx.measureText(topTextInput.value.toUpperCase()).width;
    const textHeight = fontSize;
    return (
      x >= textPos.x - textWidth / 2 &&
      x <= textPos.x + textWidth / 2 &&
      y >= textPos.y - textHeight &&
      y <= textPos.y
    );
  }

  canvas.addEventListener('mousedown', (e) => {
    if(!memeReady) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    if(isInsideText(x, y, topTextPos)) {
      draggingText = 'top';
      offset.x = x - topTextPos.x;
      offset.y = y - topTextPos.y;
    } else if(isInsideText(x, y, bottomTextPos)) {
      draggingText = 'bottom';
      offset.x = x - bottomTextPos.x;
      offset.y = y - bottomTextPos.y;
    }
  });

  canvas.addEventListener('mouseup', () => {
    draggingText = null;
  });

  canvas.addEventListener('mouseleave', () => {
    draggingText = null;
  });

  canvas.addEventListener('mousemove', (e) => {
    if(!draggingText) return;
    const rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left - offset.x;
    let y = e.clientY - rect.top - offset.y;

    // Limitar dentro del canvas
    x = Math.min(Math.max(x, 0), canvas.width);
    y = Math.min(Math.max(y, 0), canvas.height);

    if(draggingText === 'top') {
      topTextPos.x = x;
      topTextPos.y = y;
    } else if(draggingText === 'bottom') {
      bottomTextPos.x = x;
      bottomTextPos.y = y;
    }
    drawMeme();
  });
</script>

</body>
</html>
